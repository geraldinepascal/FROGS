<?xml version="1.0" encoding="UTF-8"?>
<!--
__author__ = ' Moussa Samb & Maria Bernard  & Geraldine Pascal INRAE - SIGENAE '
__copyright__ = 'Copyright (C) 2020 INRAE'
__license__ = 'GNU General Public License'
__version__ = '1.0'
__email__ = 'frogs@inrae.fr'
__status__ = 'dev'
-->
<tool id="FROGS_PICRUSt2_place_seqs" name="FPStep1" version= "1.0">
	<description>phylogenetic placement of reads: HMMER, EPA-NG, GAPPA</description>

	<requirements>
               
        
    </requirements>

    <stdio>
        <exit_code range="1:" />
        <exit_code range=":-1" />
    </stdio>
	

    <command >
	  $GALAXY_ROOT_DIR/tools/FROGS_moussa/app/placement.py --study_fasta $fasta_file --out_tree $out_file --ref_dir $input_ref --min_align $min -b $biom_file;
	</command> 


	<inputs>
	         	 <!-- Files -->
	    <!-- <param format="Fasta" name="fasta_file" type="data" label="Fasta file" help="The sequence file to filter (format: fasta)." /> -->

	    <param format="Fasta" name="fasta_file" type="data" label="Fasta file" help="The sequence file to filter (format: fasta)."
	    	optional="false">
        	<validator type="empty_field" message="This parameter is required." />
        </param>

         <param format="biom1" name="biom_file" type="data" label="Biom file" help="The abundance table of OTUs (format: biom)." optional="false">
        	<validator type="empty_field" message="This parameter is required." />
        </param>

	    <!-- <param format="biom1" name="biom_file" type="data" label="Biom file" help="The abundance file to filter (format: BIOM)."/> -->


	   			 <!-- Paramemtre-->
	   	<param name="input_ref" type="select" label="Reference Tree">
		    <option value="/Users/moussa/galaxy/tools/FROGS_moussa/tools/placement_tree/data/ref_tree_picrust2/default_files/prokaryotic/pro_ref">Procaryote</option>
		    <option value="/Users/moussa/galaxy/tools/FROGS_moussa/tools/placement_tree/data/ref_tree_picrust2/default_files/fungi/fungi_ITS">Fungi_ITS</option>
		    <option value="/Users/moussa/galaxy/tools/FROGS_moussa/tools/placement_tree/data/ref_tree_picrust2/default_files/fungi/fungi_18S">Fungi_18S</option>
		</param>
	 
		<param name="min" type="float" label="Total length" help="Proportion of the total length of an input query, minimum coverage between input query and sequences of reference tree." value="0.8" min="0" max="1" optional="false" /> 
	</inputs>


	<outputs>
		<!-- <data format="tree" name="out_file1" /> -->
		<!-- <data format="nhx" name="out_file"/> -->
		<!-- <data format="tabular" name="output_excluded" />  -->
		<!-- <data format="html" name="summary.html" /> -->

		<data format="html" name="html" label="${tool.name}: summary.html" from_work_dir="summary.html"/>
		<data format="nhx" name="out_file" label="${tool.name}: tree.nwk" from_work_dir="tree.nwk"/>
		<data format="tabular" name="output_excluded" label="${tool.name}: excluded.tsv" from_work_dir="excluded.tsv"/> 
	</outputs>


	<tests>
		<test>
			<param name="fasta_file" value="references/04-filters.fasta"/>
			<param name="biom_file"  value="references/06-affiliation.biom"/>
			<!--output name="out_tree" value="references/13-tree-mafft.nwk"/-->
			<!--output name="html" value="references/13-tree-mafft.html"/-->
			<output name="html">
 		        	<assert_contents>
                    		<has_text_matching expression="FROGS\sTree" />
                    		<has_text_matching expression="abundance_removed.*:\s0" />
                    		<has_text_matching expression="abundance_kept.*:\s45574" />
                    		<has_text_matching expression="otu_removed.*:\s0" />
                    		<has_text_matching expression="otu_kept.*:\s86" />
                	</assert_contents>
			</output>
		</test>
	</tests>


     <help>
.. image:: ./static/images/frogs_images/FROGS_logo.png  
   :height: 144
   :width: 110

.. class:: infomark page-header h2

What it does

Prediction of functional abundances based solely on the sequences of marker genes with 'PICRUSt2 &lt;https://github.com/picrust/picrust2&gt;`_. 
The first step of Picrust2 consists in placing the nucleotide sequences of the OTUs constructed elsewhere in a reference phylogenetic tree. 
The phylogenetic placement is done with `HMMER &lt;http://hmmer.org&gt;`_ to place study sequences into a reference multiple-sequence alignment  `EPA_NG &lt;https://github.com/Pbdas/epa-ng#build-instructions&gt;`_ to places these sequences into the reference phylogeny and product finaly tree with `GAPPA &lt;https://github.com/lczech/gappa&gt;`_.


.. class:: infomark page-header h2

Inputs/Outputs

.. class:: h3

Input


**OTUs fasta file**:

The OTUs sequence file (format `FASTA &lt;https://en.wikipedia.org/wiki/FASTA_format&gt;`_).

.. image:: static/images/frogs_images/frogs_tree_otufile.png

**OTUs biom file**:

The OTUs biom file (format `biom1 &lt;http://biom-format.org/documentation/format_versions/biom-1.0.html&gt;`_).
This file can be obtained in particular with the FROGS pipeline.

.. class:: h3

Outputs

**Newick file** (tree.nwk):

The phylogenetic tree in Newick format (format `nxh &lt;https://en.wikipedia.org/wiki/Newick_format&gt;`_).

 .. image:: ./static/images/frogs_images/nwk_treefile.png

**Html file** (summary.html):
   
The summary file describing which OTUs are contained or not in the phylogenetic tree.

.. class:: infomark page-header h2

**Contact**

Contacts: frogs@inra.fr

website: http://frogs.toulouse.inra.fr/

Repository: https://github.com/geraldinepascal/FROGS
website: http://frogs.toulouse.inra.fr/

Please cite the **FROGS article**: *Escudie F., et al. Bioinformatics, 2018. FROGS: Find, Rapidly, OTUs with Galaxy Solution.*

Please cite the	**PICRUSt2 article**: * Gavin M. Douglas1, Vincent J. Maffei2, Jesse Zaneveld3, Svetlana N. Yurgel4, James R. Brown5, Christopher M. Taylor2, Curtis Huttenhower6, Morgan G. I. Langille1,7,*	

     </help>

    <citation>
    	<citation type="doi">10.1101/672295</citation>
 	</citation>
 </tool>
